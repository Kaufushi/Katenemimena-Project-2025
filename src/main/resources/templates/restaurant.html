<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <title th:text="${restaurant.name}">Restaurant</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

    <!-- CSS -->
    <link rel="stylesheet" th:href="@{/css/singleRestaurant.css}">
</head>

<body>

<!-- ===== HEADER ===== -->
<header class="restaurant-header">
    <div class="header-inner">

        <div class="header-left">
            <span class="logo-icon">ğŸœ</span>
            <a th:href="@{/}" class="logo">StreetFoodGo</a>
        </div>

        <div class="header-right">

            <a class="nav-link"
               sec:authorize="isAuthenticated()"
               href="/customer/orders">
                <i class="bi bi-bag-check"></i>
                My Orders
            </a>

            <a sec:authorize="isAnonymous()"
               th:href="@{/login}"
               class="header-btn">
                Login
            </a>

            <form sec:authorize="isAuthenticated()"
                  th:action="@{/logout}"
                  method="post">
                <button type="submit" class="header-btn logout-btn">
                    Logout
                </button>
            </form>

        </div>
    </div>
</header>

<!-- ===== ALERTS ===== -->
<div th:if="${success}" class="alert alert-success">
    <span class="alert-icon">âœ“</span>
    <span th:text="${success}"></span>
</div>

<div th:if="${error}" class="alert alert-error">
    <span class="alert-icon">âœ—</span>
    <span th:text="${error}"></span>
</div>

<h2 class="restaurant-title" th:text="${restaurant.name}">
    Restaurant Name
</h2>

<main class="restaurant-container">

    <!-- ===== INFO CARD ===== -->
    <section class="restaurant-card">
        <p class="restaurant-meta">
            ğŸ“ <span th:text="${restaurant.area}"></span>
        </p>

        <p class="restaurant-meta">
            ğŸ½ï¸ <span th:text="${restaurant.cuisine}"></span>
        </p>

        <p class="restaurant-status"
           th:text="${restaurant.open ? 'Open now' : 'Closed'}"
           th:classappend="${restaurant.open ? 'open' : 'closed'}">
        </p>

        <!-- OWNER ONLY -->
        <div sec:authorize="hasRole('OWNER')" th:if="${isOwner}">
            <div class="owner-actions">
                <a th:href="@{/owner/restaurants/{id}/manage(id=${restaurant.id})}"
                   class="manage-btn">
                    âš™ï¸ Manage Restaurant
                </a>

                <a th:href="@{/owner/restaurants/{id}/orders(id=${restaurant.id})}"
                   class="orders-btn">
                    ğŸ“‹ View Orders
                </a>
            </div>
        </div>
    </section>

    <!-- ===== MENU ===== -->
    <section class="menu-section">
        <h3 class="menu-title">Menu</h3>

        <div th:if="${menuItems.isEmpty()}">
            <p class="menu-placeholder">No items available ğŸ”</p>
        </div>

        <div class="menu-grid">
            <div class="menu-item" th:each="item : ${menuItems}">

                <div class="menu-item-header">
                    <h4 th:text="${item.name}">Item</h4>
                    <span class="price">â‚¬<span th:text="${item.price}"></span></span>
                </div>

                <p class="menu-desc" th:text="${item.description}"></p>

                <span class="availability"
                      th:text="${item.available ? 'Available' : 'Unavailable'}"
                      th:classappend="${item.available ? 'available' : 'unavailable'}">
                </span>

                <div class="menu-actions">
                    <button class="add-btn"
                            th:disabled="${!item.available}"
                            th:attr="onclick=|addToCart('${item.name}', ${item.price})|">
                        â• Add
                    </button>
                </div>

            </div>
        </div>
    </section>

    <!-- ===== CART ===== -->
    <div class="cart">
        <h3>ğŸ›’ Cart</h3>

        <div id="cart-items">
            <p>No items yet</p>
        </div>

        <div class="cart-total">
            Total: â‚¬<span id="cart-total">0.00</span>
        </div>

        <div sec:authorize="isAuthenticated()">

            <div th:if="${restaurant.open}">
                <button class="checkout-btn" onclick="checkout()">Checkout</button>
            </div>

            <div th:unless="${restaurant.open}" class="checkout-disabled">
                <p>ğŸš« This restaurant is currently closed</p>
                <button class="checkout-btn" disabled>Checkout</button>
            </div>

        </div>

        <div class="login-to-checkout" sec:authorize="isAnonymous()">
            <p>Login to complete your order</p>
            <a th:href="@{/login}" class="login-btn">Login</a>
        </div>
    </div>

</main>

<script>
    let cart = JSON.parse(localStorage.getItem("cart")) || [];

    function saveCart() {
        localStorage.setItem("cart", JSON.stringify(cart));
    }

    function addToCart(name, price) {
        const existing = cart.find(i => i.name === name);
        if (existing) existing.quantity++;
        else cart.push({ name, price, quantity: 1 });

        saveCart();
        renderCart();
    }

    function removeFromCart(name) {
        const index = cart.findIndex(i => i.name === name);
        if (index === -1) return;

        if (cart[index].quantity > 1) cart[index].quantity--;
        else cart.splice(index, 1);

        saveCart();
        renderCart();
    }

    function renderCart() {
        const cartItems = document.getElementById("cart-items");
        const cartTotal = document.getElementById("cart-total");

        cartItems.innerHTML = "";
        if (cart.length === 0) {
            cartItems.innerHTML = "<p>No items yet</p>";
            cartTotal.innerText = "0.00";
            return;
        }

        let total = 0;
        cart.forEach(item => {
            total += item.price * item.quantity;
            cartItems.innerHTML += `
                <div class="cart-item">
                    <span>${item.name}</span>
                    <div class="cart-controls">
                        <button onclick="removeFromCart('${item.name}')">âˆ’</button>
                        <span>${item.quantity}</span>
                        <button onclick="addToCart('${item.name}', ${item.price})">+</button>
                    </div>
                    <span>â‚¬${(item.price * item.quantity).toFixed(2)}</span>
                </div>`;
        });

        cartTotal.innerText = total.toFixed(2);
    }

    function checkout() {
        if (cart.length === 0) {
            alert("Your cart is empty");
            return;
        }

        const restaurantId = window.location.pathname.split("/")[2];
        window.location.href = `/restaurants/${restaurantId}/checkout`;
    }

    renderCart();
</script>

</body>
</html>
