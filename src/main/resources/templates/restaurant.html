<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title th:text="${restaurant.name}">Restaurant</title>
    <link rel="stylesheet" th:href="@{/css/singleRestaurant.css}">
</head>

<body>

<!-- HEADER -->
<header class="restaurant-header">
    <div class="header-inner">
        <div class="header-left">
            <span class="logo-icon">üçú</span>
            <a th:href="@{/}" class="logo" style="text-decoration:none; color:inherit;">
                StreetFoodGo
            </a>
        </div>

        <div class="header-right">

            <!-- LOGIN (anonymous) -->
            <a sec:authorize="isAnonymous()"
               th:href="@{/login}"
               class="header-btn">
                Login
            </a>

            <!-- LOGOUT (authenticated) -->
            <form sec:authorize="isAuthenticated()"
                  th:action="@{/logout}"
                  method="post">
                <button type="submit" class="header-btn logout-btn">
                    Logout
                </button>
            </form>

        </div>
    </div>
</header>

<h2 class="restaurant-title" th:text="${restaurant.name}">
    Restaurant Name
</h2>

<main class="restaurant-container">

    <!-- RESTAURANT INFO -->
    <section class="restaurant-card">
        <div class="restaurant-info">
            <p class="restaurant-meta">
                üìç <span th:text="${restaurant.area}"></span>
            </p>

            <p class="restaurant-meta">
                üçΩÔ∏è <span th:text="${restaurant.cuisine}"></span>
            </p>

            <p class="restaurant-status"
               th:text="${restaurant.open ? 'Open now' : 'Closed'}"
               th:classappend="${restaurant.open ? 'open' : 'closed'}">
            </p>

            <!-- OWNER ONLY -->
            <div sec:authorize="hasRole('OWNER')" th:if="${isOwner}">
                <a th:href="@{/owner/restaurants/{id}/manage(id=${restaurant.id})}"
                   class="manage-btn">
                    ‚öôÔ∏è Manage Restaurant
                </a>
            </div>
        </div>
    </section>


    <section class="menu-section">
        <h3 class="menu-title">Menu</h3>

        <div th:if="${menuItems.isEmpty()}">
            <p class="menu-placeholder">No items available üçî</p>
        </div>

        <div class="menu-grid">
            <div class="menu-item"
                 th:each="item : ${menuItems}">

                <div class="menu-item-header">
                    <h4 th:text="${item.name}">Item Name</h4>
                    <span class="price">
                    ‚Ç¨<span th:text="${item.price}"></span>
                </span>
                </div>

                <p class="menu-desc"
                   th:text="${item.description}">
                </p>

                <span class="availability"
                      th:text="${item.available ? 'Available' : 'Unavailable'}"
                      th:classappend="${item.available ? 'available' : 'unavailable'}">
            </span>

                <!-- ADD TO CART -->
                <div class="menu-actions">
                    <button class="add-btn"
                            th:disabled="${!item.available}"
                            th:attr="onclick=|addToCart('${item.name}', ${item.price})|">
                        ‚ûï Add
                    </button>
                </div>

            </div>
        </div>
    </section>

    <div class="cart">
        <h3>üõí Cart</h3>

        <div id="cart-items">
            <p>No items yet</p>
        </div>

        <div class="cart-total">
            Total: <span id="cart-total">‚Ç¨0.00</span>
        </div>


        <!-- CHECKOUT -->
        <div sec:authorize="isAuthenticated()">

            <!-- OPEN -->
            <div th:if="${restaurant.open}">
                <button class="checkout-btn" onclick="checkout()">
                    Checkout
                </button>
            </div>

            <!-- CLOSED -->
            <div th:unless="${restaurant.open}" class="checkout-disabled">
                <p>üö´ This restaurant is currently closed</p>
                <button class="checkout-btn" disabled>
                    Checkout
                </button>
            </div>

        </div>



        <div class="login-to-checkout" sec:authorize="isAnonymous()">
            <p>Login to complete your order</p>
            <a th:href="@{/login}" class="login-btn">Login</a>
        </div>

    </div>



</main>

<script>

    let cart = JSON.parse(localStorage.getItem("cart")) || [];

    function saveCart() {
        localStorage.setItem("cart", JSON.stringify(cart));
    }


    function addToCart(name, price) {
        const existing = cart.find(i => i.name === name);

        if (existing) {
            existing.quantity++;
        } else {
            cart.push({ name, price, quantity: 1 });
        }

        saveCart();
        renderCart();
    }

    function removeFromCart(name) {
        const index = cart.findIndex(i => i.name === name);

        if (index === -1) return;

        if (cart[index].quantity > 1) {
            cart[index].quantity--;
        } else {
            cart.splice(index, 1);
        }

        saveCart();
        renderCart();
    }


    function renderCart() {
        const cartItemsDiv = document.getElementById("cart-items");
        const cartTotalSpan = document.getElementById("cart-total");

        cartItemsDiv.innerHTML = "";

        if (cart.length === 0) {
            cartItemsDiv.innerHTML = "<p>No items yet</p>";
            cartTotalSpan.innerText = "0.00";
            return;
        }

        let total = 0;

        cart.forEach(item => {
            total += item.price * item.quantity;

            cartItemsDiv.innerHTML += `
                <div class="cart-item">
                    <span class="cart-name">${item.name}</span>

                    <div class="cart-controls">
                        <button onclick="removeFromCart('${item.name}')">‚àí</button>
                        <span class="cart-qty">${item.quantity}</span>
                        <button onclick="addToCart('${item.name}', ${item.price})">+</button>
                    </div>

                    <span class="cart-price">
                        ‚Ç¨${(item.price * item.quantity).toFixed(2)}
                    </span>
                </div>
            `;
        });

        cartTotalSpan.innerText = total.toFixed(2);
    }


    function checkout() {
        if (cart.length === 0) {
            alert("Your cart is empty");
            return;
        }

        localStorage.setItem("cart", JSON.stringify(cart));

        const restaurantId = window.location.pathname.split("/")[2];
        window.location.href = `/restaurants/${restaurantId}/checkout`;
    }



    renderCart();
</script>



</body>
</html>
